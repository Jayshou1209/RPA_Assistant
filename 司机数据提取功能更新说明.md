# 司机数据爬取功能更新说明

**更新日期**: 2025-12-30

## 更新内容

### 1. 数据提取字段全面升级

已更新 `gui_scraper.py` 中的 `export_drivers_excel()` 方法，支持完整提取以下信息：

#### 司机基本信息 (10字段)
- Driver ID
- Name (全名)
- First Name
- Middle Name
- Last Name
- **Date of Birth** ✨ 新增
- **SSN** ✨ 新增
- **Sex** ✨ 新增
- Email
- Phone

#### 地址信息 (4字段)
- Address
- City
- State
- Zip Code

#### Driver License 证件 (5字段)
- Driver License Number
- **Driver License Issue Date** ✨ 新增
- Driver License Expired Date
- Driver License State
- **Driver License Class** ✨ 新增

#### TLC License 证件 (2字段)
- TLC License Number
- TLC License Expired Date

#### 药检证明 (6字段)
- **Sentry Drug Test Number** ✨ 新增
- **Sentry Drug Test Expired Date** ✨ 新增
- **Sentry Drug Test Status** ✨ 新增
- **ARRO Drug Test Number** ✨ 新增
- **ARRO Drug Test Expired Date** ✨ 新增
- **ARRO Drug Test Status** ✨ 新增

#### 车辆基本信息 (10字段)
- VIN Number
- Make (品牌)
- Model (型号)
- Year (年份)
- Plate Number (车牌)
- Color (颜色)
- Type (类型)
- Vehicle State
- **Seats** ✨ 新增
- **WAV Seats** ✨ 新增

#### 车辆证件 (13字段)
- **FHV Diamond Number** ✨ 新增
- **FHV Diamond Expired Date** ✨ 新增
- **FHV Diamond State** ✨ 新增
- **Insurance Policy Number** ✨ 新增
- **Insurance Expired Date** ✨ 新增
- **Insurance State** ✨ 新增
- **Insurance Company** ✨ 新增
- **Insurance Effective Date** ✨ 新增
- **Registration Number** ✨ 新增
- **Registration Expired Date** ✨ 新增
- **Registration State** ✨ 新增
- **NYS Inspection Sticker Number** ✨ 新增
- **NYS Inspection Sticker Expired Date** ✨ 新增

#### 状态信息 (3字段)
- Status
- Created At
- Updated At

**总计: 53个字段**

---

## 技术实现

### 数据提取逻辑优化

1. **从 `documents` 数组提取证件信息**
   - Driver License、TLC License、SSN、Drug Tests 等都从 API 返回的 `documents` 数组中提取
   - 正确解析每个 document 的 `type`、`number`、`expires_at`、`status` 等字段
   - 从 `options` 数组中提取额外信息（如 Issue Date、License Class、Insurance Company 等）

2. **从 `cars` 数组提取车辆信息**
   - 优先使用 `vehicle_detail`（完整车辆信息）
   - 否则使用 `cars` 数组的第一辆车
   - 从车辆的 `documents` 数组中提取证件信息

3. **字段映射优化**
   - 支持多种可能的字段名（如 `phone_number` / `phone` / `mobile`）
   - 正确处理嵌套结构和数组
   - 所有列标题使用英文字段名

---

## 使用方法

### 方法一：使用 GUI 工具（推荐）

1. 启动 GUI 工具：
   ```bash
   python gui_scraper.py
   ```
   或双击 `启动RPA助手.bat`

2. 点击 **"爬取司机数据"** 按钮

3. 系统将自动：
   - 分页获取所有司机的基本信息
   - 逐个获取每位司机的详细证件信息
   - 获取每位司机的车辆详细信息
   - 自动导出 Excel 文件（包含所有 53 个字段）
   - 自动打开生成的 Excel 文件

### 方法二：命令行测试

运行测试脚本查看数据结构：
```bash
python test_driver_extraction.py
```

---

## Excel 文件格式

### 文件名格式
```
司机完整数据_YYYYMMDD_HHMMSS.xlsx
```

### 工作表结构
- **Sheet名称**: 司机完整数据
- **表头**: 蓝色背景 + 白色加粗字体
- **冻结首行**: 方便查看数据
- **自动列宽**: 根据内容调整

### 示例数据
| Driver ID | Name | First Name | Date of Birth | SSN | Sex | Driver License Number | ... |
|-----------|------|------------|---------------|-----|-----|-----------------------|-----|
| 111574 | Yushan Wang | Yushan | 1998-05-08 | 187933409 | male | 592236325 | ... |

---

## 数据来源说明

### API 端点
- 司机列表: `GET /fleet/drivers`
- 司机详情: `GET /fleet/drivers/{driver_id}`
- 车辆详情: `GET /fleet/vehicles/{vehicle_id}`

### 数据结构
```json
{
  "driver": {
    "id": 111574,
    "first_name": "Yushan",
    "last_name": "Wang",
    "dob_date": "1998-05-08",
    "ssn": "187933409",
    "sex": "male",
    ...
  },
  "documents": [
    {
      "type": "driver_license",
      "number": "592236325",
      "expires_at": "2028-05-08",
      "state": "NY",
      "options": [
        {"name": "issue_date", "value": "2024-12-20"},
        {"name": "license_class", "value": "A"}
      ]
    },
    ...
  ],
  "cars": [...]
}
```

---

## 注意事项

1. **必须配置有效的 API Token**
   - Token 保存在 `token.txt` 文件中
   - 在 GUI 中可以测试连接状态

2. **数据获取速度**
   - 获取所有司机的详细信息需要逐个请求 API
   - 每个司机约需要 0.3 秒（包含车辆信息）
   - 500 个司机约需要 2-3 分钟

3. **字段可能为空**
   - 某些司机可能没有上传某些证件
   - 空字段在 Excel 中显示为空白

4. **日期格式**
   - API 返回的日期格式: `YYYY-MM-DD`
   - Excel 中保持原格式

---

## 测试验证

### 已验证的数据
- ✅ 司机基本信息（姓名、生日、性别、SSN 等）
- ✅ Driver License 证件（号码、发证日期、到期日期、州、类别）
- ✅ TLC License 证件
- ✅ 药检证明（Sentry、ARRO）
- ✅ 车辆基本信息（VIN、品牌、型号、年份、车牌等）
- ✅ FHV Diamond 证件
- ✅ Insurance 证件（保单号、公司、生效日期）
- ✅ Registration 证件
- ✅ NYS Inspection Sticker 证件

### 测试文件
- `test_driver_extraction.py` - 数据结构分析和字段验证
- `driver_111574_response.json` - 示例司机数据
- `car_113294_detail.json` - 示例车辆数据

---

## 已解决的问题

1. ✅ Sex 和 Date of Birth 字段未提取
2. ✅ Driver License Issue Date 未提取
3. ✅ Drug Test 信息不完整
4. ✅ 车辆证件信息缺失
5. ✅ Insurance Company 和 Effective Date 未提取
6. ✅ Excel 列标题未使用英文

---

## 后续改进建议

1. **性能优化**
   - 考虑使用多线程并发获取司机详情
   - 批量请求 API（如果 API 支持）

2. **错误处理**
   - 对获取失败的司机记录日志
   - 支持断点续传

3. **数据验证**
   - 检查必填字段是否为空
   - 验证日期格式
   - 检查证件是否过期

---

## 联系方式

如有问题或建议，请联系开发团队。

**更新者**: GitHub Copilot  
**更新日期**: 2025-12-30
