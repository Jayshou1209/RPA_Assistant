# 退工功能说明

## ✅ API已修复

根据截图Network面板，正确的退工API是：
```
POST /rides/{id}
Body: {"reason": "driver cancel"}
```

## ⚠️ 重要限制

### 只能退工未接单的订单

退工功能**只对以下状态的订单有效**：
- ✅ **pending** - 待分配
- ✅ **assigned** - 已分配但司机未接单（picked_up_at为空）

退工功能**无法处理以下状态的订单**：
- ❌ 司机已接单（picked_up_at 有值）
- ❌ 已送达完成（dropoff_at 有值）

### 您的测试案例分析

从截图看，司机106587在2025-11-22的8条订单都返回404错误：
- 订单: 11677384, 11678003, 11677698, 11678003, 11678154, 11678479, 11678523, 11678763

**原因**: 这些订单很可能都已经完成或司机已接单，所以无法退工。

测试显示：
```
订单 11677384:
状态: assigned
司机ID: 106587
已接单: 2025-11-21 19:46:41  ← 司机已接单
已送达: 2025-11-22 09:53:42  ← 已完成
```

这种状态的订单无法退工！

## 🔧 已实现的改进

### 1. 智能跳过已完成订单

现在批量退工会自动检查每个订单的状态：
```python
if dropoff:
    skip_count += 1
    log("订单已完成送达，跳过")
elif picked_up:
    skip_count += 1
    log("司机已接单，跳过")
else:
    # 只退工未接单的订单
    cancel_ride(ride_id)
```

### 2. 详细的结果报告

执行结果会显示：
- ✓ **成功**: X 条 - 成功退工的订单数
- ✗ **失败**: X 条 - API调用失败的订单数
- ⊘ **跳过**: X 条 - 已完成/已接单无法退工的订单数

## 💡 使用建议

### 什么时候可以退工？
1. **订单刚分配后** - 司机还没看到或确认
2. **司机还在路上** - 但还没点击"开始接单"
3. **计划调整** - 需要重新分配给其他司机

### 什么时候无法退工？
1. **司机已接单** - 司机已经点击"开始接单"按钮
2. **正在服务中** - 已接到乘客
3. **已完成** - 订单已送达

### 如何处理已接单的订单？
如果需要调整已接单的订单，应该：
1. 联系司机协商
2. 使用系统的其他功能（如果有"强制重新分配"等）
3. 而不是使用退工功能

## 📋 测试建议

测试退工功能时，请找一个：
- ✅ 刚分配不久的订单
- ✅ 预约时间在未来的订单
- ✅ picked_up_at 和 dropoff_at 都为 null 的订单

避免测试：
- ❌ 历史已完成订单
- ❌ 司机已确认的订单
- ❌ 正在进行中的订单
