# 司机数据爬取功能更新说明

## 更新日期
2025年12月27日

## 更新内容

### 1. 新增功能
已更新司机数据爬取功能，现在可以获取完整的司机和车辆详细信息，包括：

#### 司机证件信息
- **Driver License（驾驶执照）**
  - 证件号码
  - 到期日期
  - 所在州
  - 执照类别

- **TLC License（TLC执照）**
  - 证件号码
  - 到期日期

- **SSN（社会安全号码）**

- **药物测试**
  - Sentry Drug Test（日期、到期日、状态）
  - ARRO Drug Test（日期、到期日、状态）
  - CTG Drug Test（日期、到期日）

#### 车辆证件信息
- **FHV Diamond（FHV许可证）**
  - 证件号码
  - 到期日期

- **Insurance ID Card（保险卡）**
  - 保险号码
  - 到期日期
  - 保险公司

- **Registration（车辆登记）**
  - 登记号码
  - 到期日期

- **NYS Inspection Sticker（纽约州检验贴纸）**
  - 检验号码
  - 到期日期

#### 车辆详细信息
- VIN Number（车辆识别号）
- Make（品牌）
- Model（型号）
- Year（年份）
- Plate Number（车牌号）
- Color（颜色）
- Vehicle Type（车辆类型）

### 2. 代码更新位置

#### 文件：`real_api_scraper.py`
- 新增方法：`get_vehicle_detail(vehicle_id)` - 获取车辆详细信息
- 新增方法：`get_all_drivers_with_full_details()` - 获取所有司机的完整详细信息

#### 文件：`gui_scraper.py`
- 更新方法：`scrape_drivers_only()` - 调用新的详细爬取功能
- 更新方法：`export_drivers_excel()` - 导出包含所有字段的Excel文件

### 3. 使用方法

#### 方法1：使用GUI工具
1. 启动RPA助手：双击 `启动RPA助手.bat`
2. 选择"数据爬取工具"
3. 点击"👤 爬取司机数据"按钮
4. 等待爬取完成（会自动获取每位司机的详细信息）
5. Excel文件将自动导出并打开

#### 方法2：使用Python代码
```python
from api_client import APIClient
from real_api_scraper import RealAPIScraper

# 初始化
api_client = APIClient()
scraper = RealAPIScraper(api_client)

# 获取所有司机的完整详细信息
drivers = scraper.get_all_drivers_with_full_details(
    per_page=100,
    progress_callback=lambda c, t, m: print(f"进度: {c}/{t}")
)

# 导出Excel
import pandas as pd
# ... 使用drivers数据导出Excel
```

### 4. 数据导出格式

导出的Excel文件包含以下列（共45+列）：

**基本信息部分：**
- 司机ID、姓名、名、姓、电话、邮箱
- 街道地址、城市、州、邮编

**司机证件部分：**
- Driver License相关（4列）
- TLC License相关（2列）
- SSN
- 药物测试相关（7列）

**车辆证件部分：**
- FHV Diamond（2列）
- Insurance（3列）
- Registration（2列）
- NYS Inspection（2列）

**车辆信息部分：**
- VIN、Make、Model、Year、Plate、Color、Type

**状态信息：**
- 状态、是否激活、创建时间、更新时间

### 5. 测试

运行测试脚本验证功能：
```bash
python test_driver_scraper.py
```

测试脚本将：
1. 获取前5位司机的基本信息
2. 测试获取单个司机的详细信息
3. 测试获取车辆详细信息
4. 测试完整爬取流程

### 6. 注意事项

1. **性能考虑**
   - 获取完整详细信息需要为每位司机和车辆发送额外的API请求
   - 每位司机可能需要2-3个请求（司机详情 + 车辆详情）
   - 如果有100位司机，可能需要200-300个请求
   - 建议在非高峰期使用此功能

2. **API限制**
   - 代码已添加延迟（每个请求间隔0.3秒）以避免请求过快
   - 如遇到限流错误，请稍后重试

3. **数据准确性**
   - 不同的API版本可能返回不同的字段名称
   - 代码已尝试处理多种可能的字段名称变体
   - 如果某些字段为空，可能是API未返回该数据

4. **Excel文件**
   - 导出的Excel文件会自动打开（Windows系统）
   - 文件保存在 `data/` 目录下
   - 文件名格式：`司机完整数据_YYYYMMDD_HHMMSS.xlsx`

### 7. 故障排除

**问题1：某些字段为空**
- 可能原因：该司机未填写该信息
- 解决方法：在网页端检查该司机的详细信息是否存在

**问题2：爬取速度慢**
- 原因：需要为每位司机单独请求详细信息
- 解决方法：这是正常情况，请耐心等待

**问题3：Excel导出失败**
- 可能原因：pandas或openpyxl未安装
- 解决方法：运行 `pip install pandas openpyxl`

**问题4：API连接失败**
- 检查Token是否有效
- 检查网络连接
- 查看日志文件了解详细错误

## 技术细节

### API端点
- 司机列表：`GET /fleet/drivers`
- 司机详情：`GET /fleet/drivers/{id}`
- 车辆详情：`GET /fleet/vehicles/{id}`

### 数据结构
司机详情API返回的数据可能包含以下嵌套结构：
```json
{
  "id": 123,
  "first_name": "John",
  "last_name": "Doe",
  "driver_license": {
    "number": "D1234567",
    "expiry_date": "2026-03-30",
    "state": "NY",
    "license_class": "E"
  },
  "tlc_license": {
    "number": "5123456",
    "expiry_date": "2028-01-01"
  },
  "vehicles": [
    {
      "id": 456,
      "vin": "1HGBH41JXMN109186",
      "make": "Toyota",
      "model": "Sienna",
      ...
    }
  ]
}
```

车辆详情API返回更详细的车辆信息，包括证件数据。

## 下一步计划

1. 添加数据验证功能（检查证件是否过期）
2. 添加数据对比功能（与上次爬取结果对比）
3. 添加自动提醒功能（证件即将过期时提醒）
4. 优化性能（批量API请求、缓存机制）

## 联系方式

如有问题或建议，请查看日志文件或联系开发人员。
